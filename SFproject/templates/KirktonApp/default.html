{% extends 'KirktonApp/base.html' %}

{% block body_block %}

  <!-- map -->
 <div class="container" name="main body" >


   <div id = 'Sidepanel' class='sidepanel'>
     <a href='javascript:void(0)' class='closebtn' onclick='closeNav()'>&times;</a>
     <div><strong>Sensor Name:</strong> <span id='name'></span></div>
     <div><strong>Location:</strong> <span id='loc'></span></div>
   </div>

   <div id="main">
     <button class="openbtn" onclick="openNav()">â˜° Toggle Side panel</button>
    <div id='map' width="100%" style='height: 600px;'></div>
  </div>

<script>
function openNav() {
  document.getElementById("Sidebar").style.width = "250px";
  document.getElementById("main").style.marginLeft = "250px";
}

function closeNav() {
  document.getElementById("Sidebar").style.width = "0";
  document.getElementById("main").style.marginLeft= "0";
}
</script>

   <script>
     mapboxgl.accessToken = 'pk.eyJ1Ijoia2F0ZWhpY2tleTI2IiwiYSI6ImNrZDk5bzVxMTA2MWQzNHJ4NGRucjFxbGMifQ.XeSYaehxN9YwUmHB35pTag';

     // //adding variable bounds to the map
     // var bounds = [
     //    [-4.60, 56.00], // Southwest coordinates
     //    [-4.10, 56.88] // Northeast coordinates
     //  ];

     // map style and zoom
     var map = new mapboxgl.Map({
       container: 'map',
       style: 'mapbox://styles/mapbox/satellite-streets-v10',
       center: [-4.7118, 56.4361],
       zoom: 8
       //maxBounds: bounds // Sets bounds using 'bounds' variable
     });

     // adds zoom buttons and compass
     const nav = new mapboxgl.NavigationControl();
     map.addControl(nav, "top-right");


     // add GEOjson polygon layers, for each area of farm
        map.on('load', function() {
          // i think the issue is with the source?
          map.addSource('kirkton', {
            'type': 'geojson',
            'data': {
              'type': 'FeatureCollection',
              'generateID': true, // this ensures all features have unique IDs for the sidebar info
              'features': [
                {
                  'type': 'Feature',
                  'geometry': {
                  'type': 'Polygon',
                  'coordinates': [
                  [
              // polygon adding to map
              // these coordinates arent correct
              // but will show a triangle on the area near sensors for now - to check it works
                    [-4.3616, 56.2908],
                    [-4.3532, 56.2237],
                    [-4.4508, 56.2609]
                  ]
                ]
            }
          },
          //geojson for Sensors with correct locations
          {
            // 'type': 'FeatureCollection',
            //   "features": [
            //     {
                  'type': 'Feature',
                  'properties': {
                    'title': 'LoRaWAN Gateway 1',
                    'description': 'No description'
                  },
                  'geometry': {
                    'type': 'Point',
                    'coordinates': [-4.3937, 56.2509]
                  }
                },
                {
                  'type': 'Feature',
                  'properties': {
                    'title': 'LoRaWAN Gateway 2',
                    'description': 'No description'
                  },
                  'geometry': {
                    'type': 'Point',
                    'coordinates': [-4.4040, 56.2519]
                  }
                },
                {
                  'type': 'Feature',
                  'properties': {
                    'title': 'River Level Sensor 1',
                    'description': 'No description'
                  },
                  'geometry': {
                    'type': 'Point',
                    'coordinates': [-4.3921, 56.2455]
                  }
                },
                {
                  'type': 'Feature',
                  'properties': {
                    'title': 'River Sensor 2',
                    'description': 'No description'
                  },
                  'geometry': {
                    'type': 'Point',
                    'coordinates': [-4.3946, 56.2458]
                  }
                },
                {
                  'type': 'Feature',
                  'properties': {
                    'title': 'River Sensor 3',
                    'description': 'No description'
                  },
                  'geometry': {
                    'type': 'Point',
                    'coordinates': [-4.3936, 56.2510]
                  }
                },
                {
                  'type': 'Feature',
                  'properties': {
                    'title': 'River Sensor 4',
                    'description': 'No description'
                  },
                  'geometry': {
                    'type': 'Point',
                    'coordinates': [-4.4015, 56.2617]
                  }
                },
                {
                  'type': 'Feature',
                  'properties': {
                    'title': 'River Sensor 5',
                    'description': 'No description'
                  },
                  'geometry': {
                    'type': 'Point',
                    'coordinates': [-4.4006, 56.2607]
                  }
                },
                {
                  'type': 'Feature',
                  'properties': {
                    'title': 'River Sensor 6',
                    'description': 'No description'
                  },
                  'geometry': {
                    'type': 'Point',
                    'coordinates': [-4.3942, 56.2616]
                  }
                },
                {
                  "type": "Feature",
                  "properties": {
                    "title": "Centre of map",
                    "description": "No description"
                  },
                  "geometry": {
                    "type": "Point",
                    "coordinates": [-4.7118, 56.4361]
                  }
                }
          //    ]
             //, "type": "FeatureCollection"
         //   }
          ]
        }//;

        });

      map.addLayer({
             'id': 'farm-boundary',
             'type': 'fill',
             'source': 'kirkton',
             'paint': {
                 'fill-color': '#888888',
                 'fill-opacity': 0.4
             },
             'filter': ['==', '$type', 'Polygon']
         });

         map.addLayer({
                'id': 'park_sensors',
                'type': 'circle',
                'source': 'kirkton',
              /*   'layout': {
                                    'icon-image': '{icon}-15',
                                    'icon-allow-overlap': true
                                }, */
                 'paint': {
                    'circle-radius': 6,
                    'circle-color': '#B42222'
                },
               'filter': ['==', '$type', 'Point']

            });

            // Create a popup, but don't add it to the map yet.
            var popup = new mapboxgl.Popup({
            closeButton: false,
            closeOnClick: false
            });

          // When a click event occurs on a feature in the places layer, open a popup at the
          // location of the feature, with description HTML from its properties.
          map.on('mouseenter', 'park_sensors', function(e) {
            // Change the cursor style as a UI indicator.
            map.getCanvas().style.cursor = 'pointer';

            var coordinates = e.features[0].geometry.coordinates.slice();
            var description = e.features[0].properties.description;

            // Ensure that if the map is zoomed out such that multiple
            // copies of the feature are visible, the popup appears
            // over the copy being pointed to.
            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
            }

            // Populate the popup and set its coordinates
            // based on the feature found.
            popup
                .setLngLat(coordinates)
                .setHTML(description)
                .addTo(map);
            });

        // Change it back to a pointer when it leaves.
        map.on('mouseleave', 'park_sensors', function() {
            map.getCanvas().style.cursor = '';
            popup.remove();


        });


        // variables for sidebar info
        var  nameDisplay = document.getElementById('name');
        var locDisplay = document.getElementById('loc');

        map.on('click', 'park_sensors', (e) => {
          var sensorName = e.features[0].properties.title;
          var sensorLoc = e.features[0].properties.coordinates; // could change this to a place name instead, or area name

          // check whether features exist
          if (e.features.lenght >0){
            // display name and location in sidebar
            nameDisplay.textContent = sensorName;
            locDisplay.textContent = sensorLoc;

            // if sensorID for the clicked feature is not nill,
            // use removeFeatureState to reset to default behaviour
            if(sesnorID){
              map.removeFeatureState({
                source:'kirkton',
                id: sensorID
              });
            }

            sensorID = e.features[0].id;

            // when clicked, update feature state for the feature clicked
            map.setFeatureState({
              sourse: 'kirkton',
              id: sensorID,
            });
          }

     });

   });




     // add markers to map
    //geojson.features.function(marker){

       // // create a HTML element for each feature
       // var el = document.createElement('div');
       // el.className = 'marker-light-red';


  //    // make a marker for each feature and add to the map
  //    geojson.features.forEach(function(marker){
  //      var el = document.createElement('div');
  //      el.className = 'marker';
  //    //   new mapboxgl.Marker(el)
  //    //    .setLngLat(marker.geometry.coordinates)
  //    //    .setPopup(new mapboxgl.Popup()
  //    //    .setHTML(marker.properties.title))
  //    //    .addTo(map);
  //    // });
  // // });
  //   new mapboxgl.Marker(el)
  //     .setLngLat(marker.geometry.coordinates)
  //     .setPopup(new mapboxgl.Popup() // add popups
  //     .setHTML(marker.properties.title + marker.properties.description))
  //     .addTo(map);
  //   });




   //  // allow user to draw a polygon area
   //  var draw = new MapboxDraw({
   //    displayControlsDefault: false,
   //    controls: {
   //      polygon: true,
   //      trash: true
   //    }
   //  });
   //  map.addControl(draw);
   //
   //  map.on('draw.create', updateArea);
   //  map.on('draw.delete', updateArea);
   //  map.on('draw.update', updateArea);
   //
   //  function updateArea(e) {
   //    var data = draw.getAll();
   //    var answer = document.getElementById('calculated-area');
   //    if (data.features.length > 0) {
   //      var area = turf.area(data);
   //      // restrict to area to 2 decimal points
   //      var rounded_area = Math.round(area * 100) / 100;
   //      answer.innerHTML =
   //        '<p><strong>' +
   //        rounded_area +
   //        '</strong></p><p>square meters</p>';
   //      } else {
   //        answer.innerHTML = '';
   //        if (e.type !== 'draw.delete')
   //          alert('Use the draw tools to draw a polygon!');
   //        }
   //      }


   </script>

 </div>


{% endblock %}
