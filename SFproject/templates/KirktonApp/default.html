{% extends 'KirktonApp/base.html' %}

{% block header %}
<script src='https://api.mapbox.com/mapbox-gl-js/v1.11.1/mapbox-gl.js'></script>
<link href='https://api.mapbox.com/mapbox-gl-js/v1.11.1/mapbox-gl.css' rel='stylesheet' />
{% endblock %}

{% block body_block %}

<div id='map'></div>
  <!-- map -->
 <div class="container" name="main body" >
   <div id='map' width="100%" style='height: 600px;'></div>
   <script>
     mapboxgl.accessToken = 'pk.eyJ1Ijoia2F0ZWhpY2tleTI2IiwiYSI6ImNrZDk5bzVxMTA2MWQzNHJ4NGRucjFxbGMifQ.XeSYaehxN9YwUmHB35pTag';

    // adding bounds to the map
     var bounds = [
        [-5, 50], // Southwest coordinates
        [-3, 60] // Northeast coordinates
    ];

     // map style and zoom
     var map = new mapboxgl.Map({
       container: 'map',
       style: 'mapbox://styles/mapbox/satellite-streets-v10',
       center: [-4.66, 56.42],
       zoom: 9
       maxBounds: bounds // Sets bounds as max
     });

      // add GEOjson polygon layers, for each area of farm
      map.on('load', function() {
      map.addSource('maine', {
        'type': 'geojson',
        'data': {
          'type': 'Feature',
          'geometry': {
            'type': 'Polygon',
            'coordinates': [
            [
            // thses coordinates arent correct
              [-67.13734351262877, 45.137451890638886],
              [-66.96466, 44.8097],
              [-68.03252, 44.3252],
              [-69.06, 43.98],
              [-70.11617, 43.68405],
              [-70.64573401557249, 43.090083319667144],
              [-70.75102474636725, 43.08003225358635],
              [-70.79761105007827, 43.21973948828747],
              [-70.98176001655037, 43.36789581966826],
              [-70.94416541205806, 43.46633942318431],
              [-71.08482, 45.3052400000002],
              [-70.6600225491012, 45.46022288673396],
              [-70.30495378282376, 45.914794623389355],
              [-70.00014034695016, 46.69317088478567],
              [-69.23708614772835, 47.44777598732787],
              [-68.90478084987546, 47.184794623394396],
              [-68.23430497910454, 47.35462921812177],
              [-67.79035274928509, 47.066248887716995],
              [-67.79141211614706, 45.702585354182816],
              [-67.13734351262877, 45.137451890638886]
            ]
          ]
        }
      }
    });
    map.addLayer({
      'id': 'maine',
      'type': 'fill',
      'source': 'maine',
      'layout': {},
      'paint': {
        'fill-color': '#088',
        'fill-opacity': 0.8
    }
    });


    // allow user to draw a polygon area
    var draw = new MapboxDraw({
      displayControlsDefault: false,
      controls: {
        polygon: true,
        trash: true
      }
    });
    map.addControl(draw);

    map.on('draw.create', updateArea);
    map.on('draw.delete', updateArea);
    map.on('draw.update', updateArea);

    function updateArea(e) {
      var data = draw.getAll();
      var answer = document.getElementById('calculated-area');
      if (data.features.length > 0) {
        var area = turf.area(data);
        // restrict to area to 2 decimal points
        var rounded_area = Math.round(area * 100) / 100;
        answer.innerHTML =
          '<p><strong>' +
          rounded_area +
          '</strong></p><p>square meters</p>';
        } else {
          answer.innerHTML = '';
          if (e.type !== 'draw.delete')
            alert('Use the draw tools to draw a polygon!');
          }
        }

    // getting each sensor shown on the map as a symbol 
    var geojson = {
      type: 'Feature',
      features: [
       {% for sensor in sensors %}
       {
         type: 'Feature',
         geometry: {
           type: 'Point',
           coordinates: [{{ sensor.coord_h }}, {{ sensor.coord_v }}]
         },
         properties: {
           title: '{{ sensor.name }}',
           description: '{{ sensor.status }}' // use method to have diff colours?
         }
       },
       {% endfor %}
       ]
     };

      // add markers to map
      geojson.features.forEach(function(marker) {

        // create a HTML element for each feature
        var el = document.createElement('div');
        el.className = 'marker-green';

        // make a marker for each feature and add to the map
        new mapboxgl.Marker(el)
        .setLngLat(marker.geometry.coordinates)
        .setPopup(new mapboxgl.Popup({ offset: 25 }) // add popups
        .setHTML('<h3>' + marker.properties.title + '</h3><p>' + marker.properties.description + '</p>'))
        .addTo(map);
      });



   </script>
</div>

{% endblock %}
