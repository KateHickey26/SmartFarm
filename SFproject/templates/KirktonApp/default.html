{% extends 'KirktonApp/base.html' %}

<!--{% block header %}-->

<!--{% endblock %}-->

{% block body_block %}
<!-- <script src='https://api.mapbox.com/mapbox-gl-js/v1.11.1/mapbox-gl.js'></script>
<link href='https://api.mapbox.com/mapbox-gl-js/v1.11.1/mapbox-gl.css' rel='stylesheet' />
-->

  <!-- map -->
 <div class="container" name="main body" >
   <div id='map' width="100%" style='height: 600px;'></div>
   <script>

     mapboxgl.accessToken = 'pk.eyJ1Ijoia2F0ZWhpY2tleTI2IiwiYSI6ImNrZDk5bzVxMTA2MWQzNHJ4NGRucjFxbGMifQ.XeSYaehxN9YwUmHB35pTag';

     // // adding variable bounds to the map
     // var bounds = [
     //    [-5, 50], // Southwest coordinates
     //    [-3, 60] // Northeast coordinates
     //  ];

     // map style and zoom
     var map = new mapboxgl.Map({
       container: 'map',
       style: 'mapbox://styles/mapbox/satellite-streets-v10',
       center: [-4.66, 56.42],
       zoom: 9,
       //maxBounds: bounds // Sets bounds using 'bounds' variable

     });

     // adds zoom buttons and compass
     const nav = new mapboxgl.NavigationControl();
     map.addControl(nav, "top-right");

     // // adds a marker component
     // const marker = new mapboxgl.Marker()
     // .setLngLat([-4, 53])
     // .addTo(map);

    //  //geojson for Sensors
    //  var geojson_sensors = {
    //    type: 'FeatureCollection',
    //      features: [
    //        {
    //          "type": "Feature",
    //          "properties": {
    //            "title": "LoRaWAN Gateway 1",
    //            "description": "No description"
    //          },
    //          "geometry": {
    //            "coordinates": [56.2509, -4.3937],
    //            "type": "Point"
    //          }
    //        },
    //        {
    //          "type": "Feature",
    //          "properties": {
    //            "title": "LoRaWAN Gateway 2",
    //            "description": "No description"
    //          },
    //          "geometry": {
    //            "coordinates": [56.2519, -4.4040],
    //            "type": "Point"
    //          }
    //        },
    //        {
    //          "type": "Feature",
    //          "properties": {
    //            "title": "River Level Sensor 1",
    //            "description": "No description"
    //          },
    //          "geometry": {
    //            "coordinates": [56.2455, -4.3921],
    //            "type": "Point"
    //          }
    //        },
    //        {
    //          "type": "Feature",
    //          "properties": {
    //            "title": "River Sensor 2",
    //            "description": "No description"
    //          },
    //          "geometry": {
    //            "coordinates": [56.2458, -4.3946],
    //            "type": "Point"
    //          }
    //        },
    //        {
    //          "type": "Feature",
    //          "properties": {
    //            "title": "River Sensor 3",
    //            "description": "No description"
    //          },
    //          "geometry": {
    //            "coordinates": [56.2510, -4.3936],
    //            "type": "Point"
    //          }
    //        },
    //        {
    //          "type": "Feature",
    //          "properties": {
    //            "title": "River Sensor 4",
    //            "description": "No description"
    //          },
    //          "geometry": {
    //            "coordinates": [56.2617, -4.4015],
    //            "type": "Point"
    //          }
    //        },
    //        {
    //          "type": "Feature",
    //          "properties": {
    //            "title": "River Sensor 5",
    //            "description": "No description"
    //          },
    //          "geometry": {
    //            "coordinates": [56.2607, -4.4006],
    //            "type": "Point"
    //          }
    //        },
    //        {
    //          "type": "Feature",
    //          "properties": {
    //            "title": "River Sensor 6",
    //            "description": "No description"
    //          },
    //          "geometry": {
    //            "coordinates": [56.2616, -4.3942],
    //            "type": "Point"
    //          }
    //        },
    //        {
    //          "type": "Feature",
    //          "properties": {
    //            "title": "Air temperature and relative humidity sensor",
    //            "description": "No description"
    //          },
    //          "geometry": {
    //            "coordinates": [56.2508, -4.3939],
    //            "type": "Point"
    //          }
    //        }
    //      ],
    //      "type": "FeatureCollection"
    //    }
    //    ]
    //  };
    //
    //  // add markers to map
    // // geojson_sensors.features.function(marker){
    //
    //    // create a HTML element for each feature
    //    var el = document.createElement('div');
    //    el.className = 'marker-light-red';
    //
    //
    //  // make a marker for each feature and add to the map
    // new mapboxgl.Marker(el)
    // .setLngLat(marker.geometry.coordinates)
    // .setPopup(new mapboxgl.Popup({ offset: 25 }) // add popups
    // .setHTML(marker.properties.title + marker.properties.description))
    // .addTo(map);
    // });



   // add GEOjson polygon layers, for each area of farm
      map.on('load', function() {
        // i think the issue is with the source - it needs to have a geojson source file
        // code for adding multiple inputs from geojson, eg polygons and points
      map.addSource('kirkton', {
        'type': 'geojson',
        'data': {
          'type': 'FeatureCollection',
          'features': {
            {
            'type': 'Feature',
            'geometry': [
              'type': 'Polygon',
              'coordinates':[
            [
            // polygon adding to map
            // these coordinates arent correct
              [-67.13734351262877, 45.137451890638886],
              [-66.96466, 44.8097],
              [-68.03252, 44.3252],
              [-69.06, 43.98],
              [-70.11617, 43.68405],
              [-70.64573401557249, 43.090083319667144],
              [-70.75102474636725, 43.08003225358635],
              [-70.79761105007827, 43.21973948828747],
              [-70.98176001655037, 43.36789581966826],
              [-70.94416541205806, 43.46633942318431],
              [-71.08482, 45.3052400000002],
              [-70.6600225491012, 45.46022288673396],
              [-70.30495378282376, 45.914794623389355],
              [-70.00014034695016, 46.69317088478567],
              [-69.23708614772835, 47.44777598732787],
              [-68.90478084987546, 47.184794623394396],
              [-68.23430497910454, 47.35462921812177],
              [-67.79035274928509, 47.066248887716995],
              [-67.79141211614706, 45.702585354182816],
              [-67.13734351262877, 45.137451890638886]
            ]
          ]
        }
      },

      //points adding to map
      //do this as a "for each sensor in sensors" instead, as below?
      {
                        'type': 'Feature',
                        'geometry': {
                            'type': 'Point',
                            'coordinates': [-121.415061, 40.506229]
                        }
                    },
                    {
                        'type': 'Feature',
                        'geometry': {
                            'type': 'Point',
                            'coordinates': [-121.505184, 40.488084]
                        }
                    },
                    {
                        'type': 'Feature',
                        'geometry': {
                            'type': 'Point',
                            'coordinates': [-121.354465, 40.488737]
                        }
                    }
                ]
            }
    });
    map.addLayer({
           'id': 'farm-boundary',
           'type': 'fill',
           'source': 'kirkton',
           'paint': {
               'fill-color': '#888888',
               'fill-opacity': 0.4
           },
           'filter': ['==', '$type', 'Polygon']
       });

       map.addLayer({
           'id': 'sensors',
           'type': 'circle',
           'source': 'Kirkton',
           'paint': {
               'circle-radius': 6,
               'circle-color': '#B42222'
           },
           'filter': ['==', '$type', 'Point']
       });
   });


    // map.addLayer({
    //   'id': 'maine',
    //   'type': 'fill',
    //   'source': 'maine',
    //   'layout': {},
    //   'paint': {
    //     'fill-color': '#088',
    //     'fill-opacity': 0.8
    // }
    // });


   //  // allow user to draw a polygon area
   //  var draw = new MapboxDraw({
   //    displayControlsDefault: false,
   //    controls: {
   //      polygon: true,
   //      trash: true
   //    }
   //  });
   //  map.addControl(draw);
   //
   //  map.on('draw.create', updateArea);
   //  map.on('draw.delete', updateArea);
   //  map.on('draw.update', updateArea);
   //
   //  function updateArea(e) {
   //    var data = draw.getAll();
   //    var answer = document.getElementById('calculated-area');
   //    if (data.features.length > 0) {
   //      var area = turf.area(data);
   //      // restrict to area to 2 decimal points
   //      var rounded_area = Math.round(area * 100) / 100;
   //      answer.innerHTML =
   //        '<p><strong>' +
   //        rounded_area +
   //        '</strong></p><p>square meters</p>';
   //      } else {
   //        answer.innerHTML = '';
   //        if (e.type !== 'draw.delete')
   //          alert('Use the draw tools to draw a polygon!');
   //        }
   //      }


    // getting each sensor shown on the map as a symbol
    // var geojson = {
    //   type: 'Feature',
    //   features: [
    //    {% for sensor in sensors %}
    //    {
    //      type: 'Feature',
    //      geometry: {
    //        type: 'Point',
    //        coordinates: [{{ sensor.coord_h }}, {{ sensor.coord_v }}]
    //      },
    //      properties: {
    //        title: '{{ sensor.name }}',
    //        description: '{{ sensor.status }}' // use method to have diff colours?
    //      }
    //    },
    //    {% endfor %}
    //    ]
    //  };
    //
    //   // add markers to map
    //   geojson.features.forEach(function(marker) {
    //
    //     // create a HTML element for each feature
    //     var el = document.createElement('div');
    //     el.className = 'marker-green';
    //
    //     // make a marker for each feature and add to the map
    //     new mapboxgl.Marker(el)
    //     .setLngLat(marker.geometry.coordinates)
    //     .setPopup(new mapboxgl.Popup({ offset: 25 }) // add popups
    //     .setHTML('<h3>' + marker.properties.title + '</h3><p>' + marker.properties.description + '</p>'))
    //     .addTo(map);
    //   });

   </script>
 </div>

{% endblock %}
